cmake_minimum_required(VERSION 3.10.2)
include(CheckLanguage)

<<<<<<< HEAD
#SET(CMAKE_BUILD_TYPE "Debug")
=======
>>>>>>> b410816f1688b410931ace273d0025236447f1cd
SET(CMAKE_BUILD_TYPE "Release")
#SET(CMAKE_CXX_FLAGS_DEBUG "$ENV{CXXFLAGS} -O0 -Wall -g2 -ggdb")
SET(CMAKE_CXX_FLAGS_RELEASE "$ENV{CXXFLAGS} -O3 -Wall")

set(OpenBLAS_DIR "~/openblas/")
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_FLAGS "-O3 -Wall -Wextra -lpthread")
project(interfaces CXX)

SET(CMAKE_PREFIX_PATH ${CMAKE_SOURCE_DIR}/lib)

if ( NOT BLASType )
  # SET(BLASType "MKL")
  SET(BLASType "AmdBLIS")
endif()

add_executable(main 
  main.cpp
  library-manager.cpp
  interfaces.cpp
  get-ncores.cpp
  # runtime/lookup.cpp
  )

target_include_directories(main PRIVATE .)

add_executable(generate-domain
  generate-domain.cpp
  )


if (BLASType STREQUAL "MKL")
  message("Looking for MKL...")
  set(BLA_VENDOR Intel10_64lp)
  find_package(BLAS)
  if (BLAS_FOUND)
    target_sources(main PRIVATE MKL-context.cpp)
    target_compile_definitions(main PRIVATE USE_MKL)
    target_link_libraries(main ${BLAS_LIBRARIES})
    set(BLAS_CONFIGURED 1)
  else()
    message("Failed to find MKL!")
  endif()

elseif (BLASType STREQUAL "OpenBLAS")
  message("Looking for OpenBLAS...")
  find_library(OpenBLAS NAMES openblas PATHS "${OpenBLAS_DIR}/lib")
  if(OpenBLAS)
    target_include_directories(main PRIVATE ${OpenBLAS_DIR}/include)
    target_link_libraries(main ${OpenBLAS})
    target_sources(main PRIVATE OpenBLAS-context.cpp)
    target_compile_definitions(main PRIVATE USE_OPENBLAS)
    set(BLAS_CONFIGURED 1)
  else()
    message("Failed to find OpenBLAS!")
  endif()

elseif (BLASType STREQUAL "AmdBLIS")
  message("Looking for AmdBlis...")
  find_library(BLIS NAMES blis-mt)
  if(BLIS)
    target_include_directories(main PRIVATE .)
    target_link_libraries(main ${BLIS})
    target_sources(main PRIVATE BLIS-context.cpp)
    target_compile_definitions(main PRIVATE USE_BLIS)
    set(BLAS_CONFIGURED 1)
  else()
    message("Failed to find AmdBLIS!")
  endif()

else()
  message("UNSUPPORTED BLAS LIBRARY GIVEN ${BLASType}")
  # find_package(BLAS)
  # if (BLAS_FOUND)
  #   target_sources(main PRIVATE BLAS-context.cpp)
  #   target_compile_definitions(main PRIVATE USE_BLAS)
  #   target_link_libraries(main ${BLAS_LIBRARIES})
  # endif()
endif()

check_language(CUDA)
#set(CMAKE_CUDA_COMPILER "/usr/local/cuda-11.2/bin/nvcc")
# if (CMAKE_CUDA_COMPILER)
#   enable_language(CUDA)
#   target_sources(main PRIVATE cuBLAS-context.cu)
#   target_compile_definitions(main PRIVATE USE_CUBLAS)
#   target_link_libraries(main -lcublas)
# endif()


